#include <SoftwareSerial.h>
#include "HUSKYLENS.h"

HUSKYLENS huskylens;
SoftwareSerial mySerial(4, 5); // RX (4), TX (5)

// RGB pins (PWM)
#define RED_PIN 9
#define GREEN_PIN 10
#define BLUE_PIN 11

void setup() {
  Serial.begin(9600);
  mySerial.begin(9600);

  pinMode(RED_PIN, OUTPUT);
  pinMode(GREEN_PIN, OUTPUT);
  pinMode(BLUE_PIN, OUTPUT);

  // Start RGB OFF
  setRGB(0, 0, 0);

  // Start HuskyLens
  while (!huskylens.begin(mySerial)) {
    Serial.println("HuskyLens not connected!");
    delay(1000);
  }
  Serial.println("HuskyLens Ready.");
}

void loop() {
  if (!huskylens.request()) {
    Serial.println("Request failed");
    delay(100);  
    return;
  }

  if (huskylens.available()) {
    HUSKYLENSResult result = huskylens.read();

    Serial.print("Detected Color ID: ");
    Serial.println(result.ID);

    // Color response
    if (result.ID == 1) {
      setRGB(255, 0, 0);      // Red
      Serial.println("RGB → RED");
    }
    else if (result.ID == 2) {
      setRGB(0, 255, 0);      // Green
      Serial.println("RGB → GREEN");
    }
    else if (result.ID == 3) {
      setRGB(0, 0, 255);      // Blue
      Serial.println("RGB → BLUE");
    }
    else {
      setRGB(0, 0, 0);        // OFF if unknown
      Serial.println("RGB → OFF");
    }
  }

  delay(100);  // Avoid spamming
}

void setRGB(int r, int g, int b) {
  analogWrite(RED_PIN, r);
  analogWrite(GREEN_PIN, g);
  analogWrite(BLUE_PIN, b);
}
